
{% extends "base.html" %}
{% block content %}

<div class="project-detail-container">
  <div class="project-header">
    <h1>{{ project.title }}</h1>
    <p>{{ project.description or "No description available" }}</p>
  </div>

  <div class="actions">
    <button class="btn-primary open-panel-btn" id="openAddTaskPanel">
      <i data-lucide="plus"></i>
       Add Task
    </button>
  </div>

  <div class="task-grid">
    {% for task in tasks %}
    <div class="task-card"
         data-id="{{ task.id }}"
         data-title="{{ task.title }}"
         data-desc="{{ task.description or '' }}"
         data-status="{{ task.status or 'todo' }}"
         data-priority="{{ task.priority or 'Medium' }}"
         data-assignee="{{ task.assignee_id or '' }}"
         data-due="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">

      <div class="task-header">
        <h3 class="task-title">{{ task.title }}</h3>
        <div class="task-actions">
          <button class="btn-edit open-edit-btn"
                  data-id="{{ task.id }}"
                  data-title="{{ task.title }}"
                  data-description="{{ task.description }}"
                  data-assignee="{{ task.assignee_id or '' }}"
                  data-priority="{{ task.priority }}"
                  data-status="{{ task.status }}"
               
                  data-due="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
            Edit
          </button>

          <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" style="display:inline;">
            <button type="submit" class="btn-delete">Delete</button>
          </form>
        </div>
      </div>

      <p class="task-desc">{{ task.description or "No description available" }}</p>

      <div class="task-info">
        <p><strong>Status:</strong> <span class="status">{{ task.status or "To Do" }}</span></p>
        <p><strong>Priority:</strong>
          <span class="priority-tag {{ task.priority|lower }}">{{ task.priority or "Medium" }}</span>
        </p>
        <p><strong>Due Date:</strong>
          {% if task.due_date %}
            {{ task.due_date.strftime('%Y-%m-%d') }}
          {% else %}
            Not set
          {% endif %}
        </p>
        <p><strong>Assignee:</strong>
          {% if task.assignee %}
            {{ task.assignee.name }}
          {% else %}
            Unassigned
          {% endif %}
        </p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Add Task Panel -->
<div class="side-panel" id="addTaskPanel">
  <div class="panel-content">
    <span class="close-panel" id="closeAddPanel">&times;</span>
    <h2>Add New Task</h2>
    <form method="POST" action="{{ url_for('add_task_to_project', project_id=project.id) }}" class="panel-form">
      <label>Task Title:</label>
      <input type="text" name="title" required>

      <label>Description:</label>
      <textarea name="description"></textarea>

      <label>Assign To:</label>
      <select name="assignee_id">
        <option value="">-- Select --</option>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name or u.email }}</option>
        {% endfor %}
      </select>

      <label>Priority:</label>
      <select name="priority">
        <option value="Low">Low</option>
        <option value="Medium" selected>Medium</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>
      </select>

      <label>Due Date:</label>
      <input type="date" name="due_date">

      <button type="submit" class="btn-primary">Create Task</button>
    </form>
  </div>
</div>

<!-- Edit Task Panel -->
<div class="side-panel" id="editTaskPanel">
  <div class="panel-content">
    <span class="close-panel" id="closeEditPanel">&times;</span>
    <h2>Edit Task</h2>
    <form method="POST" id="editTaskForm">
      <input type="hidden" name="task_id" id="editTaskId">

      <label>Task Title:</label>
      <input type="text" name="title" id="editTitle" required>

      <label>Description:</label>
      <textarea name="description" id="editDescription"></textarea>

      <label>Status:</label>
      <select name="status" id="editStatus">
        <option value="todo">To Do</option>
        <option value="in-progress">In Progress</option>
        <option value="done">Done</option>
      </select>

      <label>Priority:</label>
      <select name="priority" id="editPriority">
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>
      </select>

      <label>Assignee:</label>
      <select name="assignee_id" id="editAssignee">
        <option value="">-- Select --</option>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name or u.email }}</option>
        {% endfor %}
      </select>

      <label>Due Date:</label>
      <input type="date" name="due_date" id="editDueDate">

      <button type="submit" class="btn-primary">Save Changes</button>
    </form>
  </div>
</div>
<div id="overlay"></div>

<style>
#overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(3px);
  z-index: 1500;
  transition: opacity 0.3s ease;
}
#overlay.active { display: block; opacity: 1; }
</style>

<script>
const overlay = document.getElementById("overlay");
openAdd.addEventListener("click", () => overlay.classList.add("active"));
closeAdd.addEventListener("click", () => overlay.classList.remove("active"));
document.addEventListener("click", (e) => {
  if (!addPanel.contains(e.target) && !e.target.classList.contains("btn-primary")) {
    overlay.classList.remove("active");
  }
});
</script>

<style>

/* === Container === */
.project-detail-container {
  max-width: 1100px;
  margin: 40px auto;
  padding: 20px;
}

/* === Header === */
.project-header {
  background: linear-gradient(135deg, #b892ff, #7c5cff);
  padding: 22px 30px;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
}

.project-header h1 {
  font-size: 2rem;
  color: #fff;
  font-weight: 700;
  margin: 0;
}

.project-header p {
  color: #eee;
  font-size: 1rem;
  margin-top: 6px;
}

/* === Primary (Add Task) Button === */
.btn-primary {
  background: #6c4be8;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(108, 75, 232, 0.3);
}

.btn-primary:hover {
  background: #5938d4;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(108, 75, 232, 0.4);
}

/* === Task Grid === */
.task-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
  margin-top: 20px;
}

/* === Task Card === */
.task-card {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-top: 5px solid #6c4be8;
  display: flex;
  flex-direction: column;
}

.task-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 16px rgba(0, 0, 0, 0.12);
}

/* === Priority Border Colors === */
.task-card.low { border-top-color: #28a745; }
.task-card.medium { border-top-color: #ffc107; }
.task-card.high { border-top-color: #fd7e14; }
.task-card.urgent { border-top-color: #dc3545; }

/* === Header: Title + Buttons Aligned === */
.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  width: 100%;
}

.task-title {
  flex: 1;
  font-size: 1.15rem;
  font-weight: 700;
  color: #222;
  margin: 0;
  word-break: break-word;
}

/* === Task Actions (Right-Aligned Buttons) === */
.task-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
}
/* === Buttons (Uniform Look) === */
.btn-edit,
.btn-delete {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 38px;              
  min-width: 90px;           
  padding: 0 18px;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  color: #fff !important;
  text-decoration: none !important;
  line-height: 1;  
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}
/* Edit Button (Green) */
.btn-edit {
  background: #28a745;
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}
.btn-edit:hover {
  background: #218838;
  transform: translateY(-1px);
}

/* Delete Button (Red) */
.btn-delete {
  background: #dc3545;
  box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
}
.btn-delete:hover {
  background: #b02a37;
  transform: translateY(-1px);
}
.btn-edit, .btn-delete {
  width: 100px;
}

/* === Task Description + Info === */
.task-desc {
  color: #555;
  margin: 10px 0;
  font-size: 0.95rem;
  line-height: 1.5;
}

.task-info p {
  margin: 4px 0;
  font-size: 0.9rem;
  color: #333;
}
.task-info p strong {
  font-weight: 600;
  color: #000;
}
.task-actions button {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}
.task-actions button:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
}

/* === Priority Tag === */
.priority-tag {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 13px;
  text-transform: capitalize;
  color: #fff;
}
.priority-tag.low { background: #28a745; }
.priority-tag.medium { background: #ffc107; color: #000; }
.priority-tag.high { background: #fd7e14; }
.priority-tag.urgent { background: #dc3545; }

/* === Status === */
.status {
  text-transform: capitalize;
  color: #6c4be8;
  font-weight: 600;
}

/* === Side Panel === */
.side-panel {
  position: fixed;
  top: 0;
  right: -420px;
  width: 400px;
  height: 100%;
  background: #fff;
  box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
  overflow-y: auto;
  transition: right 0.35s ease, opacity 0.3s ease;
  z-index: 2000;
  opacity: 0;
  border-radius: 10px 0 0 10px;
}

.side-panel.active {
  right: 0;
  opacity: 1;
}

.panel-content {
  padding: 25px;
  position: relative;
  animation: slideIn 0.3s ease forwards;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}

.close-panel {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 1.5rem;
  cursor: pointer;
  color: #444;
  transition: color 0.2s ease;
}
.close-panel:hover {
  color: #6c4be8;
}

.panel-form label {
  font-weight: 600;
  display: block;
  margin-top: 10px;
}
.panel-form input,
.panel-form textarea,
.panel-form select {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.95rem;
}
.panel-form button {
  margin-top: 15px;
  width: 100%;
}

/* === Footer (Optional) === */
.footer {
  text-align: center;
  color: #888;
  margin-top: 40px;
  font-size: 0.9rem;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addPanel = document.getElementById("addTaskPanel");
  const editPanel = document.getElementById("editTaskPanel");
  const openAdd = document.getElementById("openAddTaskPanel");
  const closeAdd = document.getElementById("closeAddPanel");
  const closeEdit = document.getElementById("closeEditPanel");
  const editForm = document.getElementById("editTaskForm");

  // --- Add Panel ---
  openAdd?.addEventListener("click", (e) => {
    e.preventDefault();
    addPanel.classList.add("active");
  });
  closeAdd?.addEventListener("click", () => addPanel.classList.remove("active"));

  // --- Edit Panel ---
  closeEdit?.addEventListener("click", () => editPanel.classList.remove("active"));

  document.querySelectorAll(".open-edit-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      editPanel.classList.add("active");
      document.getElementById("editTaskId").value = btn.dataset.id;
      document.getElementById("editTitle").value = btn.dataset.title;
      document.getElementById("editDescription").value = btn.dataset.description;
      document.getElementById("editStatus").value = btn.dataset.status;
      document.getElementById("editPriority").value = btn.dataset.priority;
      document.getElementById("editAssignee").value = btn.dataset.assignee;
      document.getElementById("editDueDate").value = btn.dataset.due;
    });
  });

  // --- Close Panels on outside click ---
  document.addEventListener("click", (e) => {
    const insideAdd = addPanel.contains(e.target) || e.target === openAdd;
    const insideEdit = editPanel.contains(e.target) || e.target.classList.contains("open-edit-btn");

    if (!insideAdd && addPanel.classList.contains("active")) addPanel.classList.remove("active");
    if (!insideEdit && editPanel.classList.contains("active")) editPanel.classList.remove("active");
  });

  // --- Edit Task Submit ---
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("editTaskId").value;
    const data = {
      title: document.getElementById("editTitle").value,
      description: document.getElementById("editDescription").value,
      status: document.getElementById("editStatus").value,
      priority: document.getElementById("editPriority").value,
      assignee_id: document.getElementById("editAssignee").value,
      due_date: document.getElementById("editDueDate").value,
    };

    const res = await fetch(`/tasks/${id}/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      const card = document.querySelector(`.task-card[data-id='${id}']`);
      if (card) {
        card.querySelector(".task-title").textContent = data.title;
        card.querySelector(".task-desc").textContent = data.description || "No description available";
        card.querySelector(".status").textContent = data.status;

        const priorityTag = card.querySelector(".priority-tag");
        priorityTag.textContent = data.priority;
        priorityTag.className = `priority-tag ${data.priority.toLowerCase()}`;

        const borderColors = {
          low: "#28a745",
          medium: "#ffc107",
          high: "#fd7e14",
          urgent: "#dc3545",
        };
        card.style.borderTopColor = borderColors[data.priority.toLowerCase()];
      }
      editPanel.classList.remove("active");
    } else {
      alert("‚ùå Error updating task.");
    }
  });

  // --- ‚úÖ DELETE TASK (fixed to work properly) ---
  window.deleteTask = async function (taskId, event) {
    event?.preventDefault();
    event?.stopPropagation();

    if (!confirm("üóëÔ∏è Delete this task?")) return;

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = "Deleting...";

    try {
      const res = await fetch(`/delete_task/${taskId}`, { method: "POST" });

      if (res.status === 204) {
        const card = document.querySelector(`.task-card[data-id='${taskId}']`);
        if (card) {
          card.style.transition = "opacity 0.3s ease, transform 0.3s ease";
          card.style.opacity = "0";
          card.style.transform = "translateY(-10px)";
          setTimeout(() => card.remove(), 300);
        }
      } else {
        alert("‚ö†Ô∏è Failed to delete task. Status: " + res.status);
      }
    } catch (err) {
      console.error("Delete error:", err);
      alert("‚ùå Network error. Could not delete task.");
    } finally {
      btn.disabled = false;
      btn.textContent = "Delete";
    }
  };

  // Replace all <form> based deletes with AJAX
  document.querySelectorAll(".task-card form").forEach((form) => {
    const btn = form.querySelector(".btn-delete");
    const id = form.closest(".task-card").dataset.id;
    btn.addEventListener("click", (e) => deleteTask(id, e));
    form.addEventListener("submit", (e) => e.preventDefault()); // prevent page reload
  });
});
</script>



{% endblock %}
